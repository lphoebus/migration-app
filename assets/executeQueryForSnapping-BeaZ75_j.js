import{fb as v,bw as F,fc as I,bo as S,fd as T,fe as w,bM as h,bv as b}from"./index-ChIkxCSH.js";import{d as M,O,V as Q}from"./QueryEngine-BRXhJfxe.js";import{I as j}from"./timeSupport-DQiMTjpj.js";async function Z(e,i,u){const a=v(u),{point:t,distance:n,returnEdge:p,vertexMode:o}=i;if(!p&&o==="none")return{candidates:[]};let s=F(i.query);s=await e.schedule(()=>I(s,e.definitionExpression,e.spatialReference),a),s=await e.reschedule(()=>M(s,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),a);const f=!S(t.spatialReference,e.spatialReference);f&&await T(t.spatialReference,e.spatialReference);const d=typeof n=="number"?n:n.x,m=typeof n=="number"?n:n.y,y={xmin:t.x-d,xmax:t.x+d,ymin:t.y-m,ymax:t.y+m,spatialReference:t.spatialReference},r=f?w(y,e.spatialReference):y;if(!r)return{candidates:[]};const x=(await h(b(t),null,{signal:a}))[0],c=(await h(b(r),null,{signal:a}))[0];if(x==null||c==null)return{candidates:[]};const l=new O(await e.reschedule(()=>e.searchFeatures(Q(c.toJSON())),a),s,e);await e.reschedule(()=>e.executeObjectIdsQuery(l),a),await e.reschedule(()=>e.executeTimeQuery(l),a),await e.reschedule(()=>e.executeAttributesQuery(l),a),await e.reschedule(()=>q(e,l,a),a);const R=x.toJSON(),g=f?w(R,e.spatialReference):R,$=f?Math.max(r.xmax-r.xmin,r.ymax-r.ymin)/2:n;return l.createSnappingResponse({...i,point:g,distance:$},s.returnZ,t.spatialReference)}async function q(e,i,u){var o;const{query:a}=i,{spatialRel:t}=a;if(!((o=i==null?void 0:i.items)!=null&&o.length)||!a.geometry||!t)return;const n=await j(t,a.geometry,e.geometryType,e.hasZ,e.hasM),p=await e.runSpatialFilter(i.items,s=>n(s.geometry),u);i.items=p}export{Z as u};
